# è¿æ¥ç¨³å®šæ€§é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜åˆ†æ

é¡¹ç›®é¢‘ç¹å‡ºç°"disconnected -> session is null"çŠ¶æ€ï¼Œä¸»è¦åŸå› åŒ…æ‹¬ï¼š

1. **ä¼šè¯æ¸…ç†è¿‡äºæ¿€è¿›**ï¼šç”¨æˆ·60ç§’ä¸æ´»è·ƒå°±è¢«æ¸…ç†
2. **å¿ƒè·³æœºåˆ¶ä¸å¤Ÿç¨³å®š**ï¼šå¿ƒè·³é—´éš”çŸ­ï¼Œå®¹é”™æ€§ä¸è¶³
3. **è¿æ¥çŠ¶æ€ç®¡ç†æ··ä¹±**ï¼šå¤šä¸ªè¿æ¥ç®¡ç†å™¨çŠ¶æ€åŒæ­¥é—®é¢˜
4. **é”™è¯¯å¤„ç†ä¸å¤Ÿå¥å£®**ï¼šç½‘ç»œæ³¢åŠ¨æ—¶å®¹æ˜“æ–­å¼€

## ğŸ”§ ä¸»è¦ä¿®å¤

### 1. ä¼šè¯æ¸…ç†é€»è¾‘ä¼˜åŒ– (`lib/session-store.ts`)

- **æ´»è·ƒæ£€æµ‹æ—¶é—´**ï¼š60ç§’ â†’ 120ç§’ï¼ˆå¢åŠ å®¹é”™æ€§ï¼‰
- **æ¸…ç†ç­–ç•¥**ï¼šåªæœ‰å½“ç”¨æˆ·æ•°é‡æ˜¾è‘—å‡å°‘æ—¶æ‰æ¸…ç†ï¼ˆ80%é˜ˆå€¼ï¼‰
- **é”™è¯¯å¤„ç†**ï¼šè¿”å›nullè€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯ï¼Œé¿å…çº§è”å¤±è´¥

```typescript
// æ¸…ç†ä¸æ´»è·ƒç”¨æˆ·ï¼ˆ120ç§’æœªæ´»è·ƒï¼Œå¢åŠ å®¹é”™æ€§ï¼‰
const activeUsers = session.users.filter(
  (user) => now - user.lastSeen < 120000 // ä»60ç§’å¢åŠ åˆ°120ç§’
);

// åªæœ‰å½“ç”¨æˆ·æ•°é‡æ˜¾è‘—å‡å°‘æ—¶æ‰æ¸…ç†ï¼ˆ80%é˜ˆå€¼ï¼‰
if (activeUsers.length < session.users.length * 0.8) {
  // æ‰§è¡Œæ¸…ç†
}
```

### 2. ä¼šè¯çŠ¶æ€ç®¡ç†æ”¹è¿› (`components/point-estimation-tool/hooks/useSessionState.ts`)

- **é‡è¯•æœºåˆ¶**ï¼šæ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- **è½®è¯¢é¢‘ç‡ä¼˜åŒ–**ï¼š2ç§’ â†’ 3ç§’ï¼Œå¿ƒè·³10ç§’ â†’ 10ç§’
- **é”™è¯¯å¤„ç†å¢å¼º**ï¼šæ›´å¥½çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
- **è¿æ¥ç¨³å®šæ€§å¢å¼ºå™¨é›†æˆ**ï¼šè‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œæ¢å¤

```typescript
// æ·»åŠ é‡è¯•æœºåˆ¶
let retryCount = 0;
const maxRetries = 3;

while (retryCount < maxRetries) {
  try {
    const result = await getSessionData(sessionId);
    if (result.success && result.session) {
      // æˆåŠŸå¤„ç†
      return;
    }
  } catch (error) {
    retryCount++;
    // æŒ‡æ•°é€€é¿é‡è¯•
    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
  }
}
```

### 3. è¿æ¥ç¨³å®šæ€§å¢å¼ºå™¨ (`lib/connection-stability-enhancer.ts`)

- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€
- **è‡ªåŠ¨æ¢å¤**ï¼šæ£€æµ‹åˆ°ä¸å¥åº·æ—¶è‡ªåŠ¨å°è¯•æ¢å¤
- **å¤±è´¥è®¡æ•°**ï¼šè·Ÿè¸ªè¿ç»­å¤±è´¥æ¬¡æ•°
- **å“åº”æ—¶é—´ç›‘æ§**ï¼šç›‘æ§å¹³å‡å“åº”æ—¶é—´

```typescript
export class ConnectionStabilityEnhancer {
  // è®°å½•è¿æ¥æˆåŠŸ
  recordSuccess(connectionType: string, responseTime: number): void
  
  // è®°å½•è¿æ¥å¤±è´¥
  recordFailure(reason: string, connectionType: string): void
  
  // å¼€å§‹æ¢å¤è¿‡ç¨‹
  async startRecovery(): Promise<void>
}
```

### 4. æ··åˆè¿æ¥ç®¡ç†å™¨ä¼˜åŒ– (`lib/hybrid-connection-manager.ts`)

- **è¶…æ—¶è®¾ç½®**ï¼š10ç§’ â†’ 15ç§’ï¼ˆå¢åŠ å®¹é”™æ€§ï¼‰
- **é‡è¿å°è¯•æ¬¡æ•°**ï¼šå¢åŠ é‡è¿å°è¯•æ¬¡æ•°
- **æˆåŠŸè¿æ¥è®°å½•**ï¼šè®°å½•æˆåŠŸè¿æ¥åˆ°ç¨³å®šæ€§ç›‘æ§å™¨
- **æ›´å¥½çš„é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯

### 5. è¿æ¥è°ƒè¯•é¢æ¿ (`components/connection-debug-panel/index.tsx`)

- **å®æ—¶ç›‘æ§**ï¼šæ˜¾ç¤ºå½“å‰è¿æ¥çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯
- **ç¨³å®šæ€§æŠ¥å‘Š**ï¼šæ˜¾ç¤ºè¿æ¥ç¨³å®šæ€§ç»Ÿè®¡
- **é—®é¢˜ä¼šè¯è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«é¢‘ç¹æ–­å¼€çš„ä¼šè¯
- **è°ƒè¯•æ—¥å¿—**ï¼šæ˜¾ç¤ºæœ€è¿‘çš„è¿æ¥æ—¥å¿—

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### è¿æ¥ç¨³å®šæ€§æå‡
- **ç”¨æˆ·æ´»è·ƒæ£€æµ‹**ï¼š120ç§’å®¹é”™æ—¶é—´ï¼Œå‡å°‘è¯¯æ¸…ç†
- **é‡è¯•æœºåˆ¶**ï¼š3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ï¼Œæé«˜æˆåŠŸç‡
- **å¥åº·æ£€æŸ¥**ï¼š30ç§’å¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨æ¢å¤æœºåˆ¶

### é”™è¯¯å¤„ç†å¢å¼º
- **é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†ç½‘ç»œé”™è¯¯ã€ä¼šè¯é”™è¯¯ç­‰
- **é‡è¿ç­–ç•¥**ï¼šæ™ºèƒ½é‡è¿ï¼Œé¿å…æ— é™é‡è¯•
- **çŠ¶æ€åŒæ­¥**ï¼šæ›´å¥½çš„è¿æ¥çŠ¶æ€ç®¡ç†

### ç›‘æ§å’Œè°ƒè¯•
- **å®æ—¶ç›‘æ§**ï¼šè¿æ¥çŠ¶æ€å®æ—¶æ˜¾ç¤º
- **ç»Ÿè®¡åˆ†æ**ï¼šè¿æ¥æˆåŠŸç‡ã€æ–­å¼€åŸå› ç»Ÿè®¡
- **é—®é¢˜è¯Šæ–­**ï¼šè‡ªåŠ¨è¯†åˆ«é—®é¢˜ä¼šè¯

## ğŸš€ ä½¿ç”¨å»ºè®®

1. **å¼€å‘ç¯å¢ƒ**ï¼šå¯ç”¨è°ƒè¯•é¢æ¿ç›‘æ§è¿æ¥çŠ¶æ€
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šè¿æ¥ç¨³å®šæ€§å¢å¼ºå™¨è‡ªåŠ¨å·¥ä½œ
3. **é—®é¢˜æ’æŸ¥**ï¼šä½¿ç”¨è°ƒè¯•é¢æ¿æŸ¥çœ‹è¿æ¥ç»Ÿè®¡

## ğŸ” ç›‘æ§æŒ‡æ ‡

- **è¿æ¥æˆåŠŸç‡**ï¼šç›®æ ‡ > 95%
- **å¹³å‡æ–­å¼€é—´éš”**ï¼šç›®æ ‡ > 300ç§’
- **é‡è¿å°è¯•æ¬¡æ•°**ï¼šç›®æ ‡ < 3æ¬¡
- **å“åº”æ—¶é—´**ï¼šç›®æ ‡ < 2000ms

è¿™äº›ä¿®å¤åº”è¯¥æ˜¾è‘—æ”¹å–„è¿æ¥ç¨³å®šæ€§ï¼Œå‡å°‘"disconnected -> session is null"çŠ¶æ€çš„å‡ºç°ã€‚ 